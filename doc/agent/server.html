<!DOCTYPE html>
<html>
    <head>
        <script src="../../lib/autobahn.min.js"></script>
        <script src="../../cloudeebus/cloudeebus.js"></script>
        <script type="text/javascript">
		function evalScript() {
			eval(
				"var lambda = function() {" +
					document.getElementById('script').value +
				"};" + 
				"lambda();"
			);
		}
        </script>
    </head>
   <body>
        <center><h1>cloudeebus</h1></center>
        <br>
		<textarea style="width:80%" rows="32" id="script">var sampleXml= '<!DOCTYPE node PUBLIC "-//freedesktop//DTD D-BUS Object Introspection 1.0//EN"\n"http://www.freedesktop.org/standards/dbus/1.0/introspect.dtd">\n<node><interface name="org.cloudeebus.Sample1"><method name="Release"></method><method name="Add"><arg type="i" name="arg1"/><arg type="i" name="arg2"/><arg type="i" name="result" direction="out"/></method><method name="Variant"><arg type="a{sv}" name="arg1"/><arg type="a{sv}" name="result" direction="out"/></method><signal name="ResultChanged"><arg type="v" name="result"/></signal></interface><interface name="org.cloudeebus.Sample2"><method name="Div"><arg type="d" name="arg1"/><arg type="d" name="arg2"/><arg type="d" name="result" direction="out"/></method></interface></node>';
cloudeebus.log = function(msg) {
  document.getElementById("log").innerHTML += msg + "\n";
}

function logCB(result) {
  cloudeebus.log(JSON.stringify(result));
}

function errorCB(error) {
  cloudeebus.log(error.desc ? error.desc : error);
}

sampleObjectHandler = {
  Add: function(a,b) {
    cloudeebus.log("Add " + a + " + " + b);
    this.ResultChanged(a+b);
    return a+b;
  }, 
  Variant: function(a) {
    cloudeebus.log("Get and return :" + JSON.stringify(a));
    return a;
  }, 
  Release: function() {
    cloudeebus.SessionBus().service.delAgent("/org/cloudeebus/Sample", logCB, errorCB);
    cloudeebus.SessionBus().service.remove(logCB, errorCB);
  },
  interfaceProxies : {
    "org.cloudeebus.Sample2" : {
      Div: function(a,b) {
        cloudeebus.log("Div " + a + " / " + b);
    	this.ResultChanged(a/b);
        return a/b;
      } 
    }
  }
};

sampleObjectHandler2 = {
  interfaceProxies : {
    "org.cloudeebus.Sample1" : {
  	  Add: function(a,b) {
    	this.interfaceProxies["org.cloudeebus.Sample1"].ResultChanged(a+b);
    	return a+b;
      }, 
      Release: function() {
        cloudeebus.SessionBus().service.delAgent("/org/cloudeebus/Sample", logCB, errorCB);
        cloudeebus.SessionBus().service.remove(logCB, errorCB);
      },
    },
    "org.cloudeebus.Sample2" : {
      Div: function(a,b) {
        return a/b;
      } 
    }
  }
};

function serviceAdded(service) {
  var agentName = "/org/cloudeebus/Sample"; // = DBUS object name
  cloudeebus.SessionBus().service.addAgent(agentName, sampleXml, sampleObjectHandler, logCB, errorCB);
}

function connectSuccess() {
  cloudeebus.SessionBus().addService("org.cloudeebus.Sample", serviceAdded, errorCB);
}

cloudeebus.connect("ws://localhost:9003", null, connectSuccess, errorCB);
</textarea>
		<br>
		<input type="button" value="run script" onclick="evalScript()"/>
		<input type="button" value="clear log" onclick="document.getElementById('log').innerHTML='';"/>
		<br>
		<pre id="log" style="height: 20em; overflow-x: auto; overflow-y: auto; background-color: #faa;"></pre>
   </body>
</html>
