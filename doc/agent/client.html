<!DOCTYPE html>
<html>
    <head>
        <script src="../../lib/autobahn.min.js"></script>
        <script src="../../cloudeebus/cloudeebus.js"></script>
        <script type="text/javascript">
		function evalScript() {
			eval(
				"var lambda = function() {" +
					document.getElementById('script').value +
				"};" + 
				"lambda();"
			);
		}
        </script>
    </head>
   <body>
        <center><h1>cloudeebus</h1></center>
        <br>
		<textarea style="width:80%" rows="32" id="script">
var manifest = {
	name: "cloudeebus",
	key: "secret",
	permissions: [
		"org.cloudeebus.Sample"
	]
};


var sampleProxy = null;

cloudeebus.log = function(msg) {
  document.getElementById("log").innerHTML += msg + "\n";
}

function logCB(result) {
  cloudeebus.log(JSON.stringify(result));
}

function errorCB(error) {
  cloudeebus.log(error.desc ? error.desc : error);
}

function gotDictResult(result) {
  cloudeebus.log("gotDictResult: " + JSON.stringify(result));
  cloudeebus.log("Name: " + result.Name);
}

function gotDivResult(result) {
  cloudeebus.log("gotDivResult: " + result);
  var dictionary = {Name: "Mickey",
  				 Sisters: [""], 
  				 Married: true,
  				 Divorced: 0,
  				 Friends: ["Donald", "Dingo"],
  				 Others: [""]};
  sampleProxy.Variant(dictionary).then(gotDictResult,errorCB);  
//  sampleProxy.Release();
}

function gotAddResult(result) {
  cloudeebus.log("gotAddResult: " + result);
  logCB('Divide by 3.33');
  sampleProxy.Div(result,3.33).then(gotDivResult,errorCB);
}

function signalHandler(result) {
  cloudeebus.log("signal 'ResultChanged': " + result);
}

function gotProxy(proxy) {
	sampleProxy = proxy;
   logCB(sampleProxy);
  if (0) {
    proxy.Release();
    return;
   } else {
	  proxy.connectToSignal("org.cloudeebus.Sample1", "ResultChanged", signalHandler);
	  logCB('Addition');
	  
	  for (var i=-10; i<10; i++)
	    proxy.Add(i,i*2).then(gotAddResult,errorCB);
  }
  
}

function connectSuccess() {
  cloudeebus.SessionBus().getObject("org.cloudeebus.Sample", "/org/cloudeebus/Sample", gotProxy, errorCB);
}

cloudeebus.connect("ws://localhost:9002", manifest, connectSuccess, errorCB);
</textarea>
		<br>
		<input type="button" value="run script" onclick="evalScript()"/>
		<input type="button" value="clear log" onclick="document.getElementById('log').innerHTML='';"/>
		<br>
		<pre id="log" style="height: 20em; overflow-x: auto; overflow-y: auto; background-color: #faa;"></pre>
   </body>
</html>
